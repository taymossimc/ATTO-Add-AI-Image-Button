YUI.add("moodle-atto_aiimage-button",function(e,t){var n="atto_aiimage",o="atto_aiimage",r={INPUTSUBMIT:"atto_aiimage_submit",INPUTCANCEL:"atto_aiimage_cancel",INPUTPROMPT:"atto_aiimage_prompt",ASPSETRATIO_SQUARE:"atto_aiimage_ratio_square",ASPSETRATIO_LANDSCAPE:"atto_aiimage_ratio_landscape",ASPSETRATIO_PORTRAIT:"atto_aiimage_ratio_portrait",PROCESSING:"atto_aiimage_processing"},i=!0;function a(e,t,n){return"string"!=typeof e?"":void 0!==n?e.substring(t,n):e.substring(t)}function s(e){return void 0===e||null===e?"":String(e)}e.namespace("M.atto_aiimage").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_apiSettings:null,_form:null,_content:null,_isInserting:!1,initializer:function(){i&&console.log(o+": Initializing AI Image button"),this._apiSettings={hasapikey:!1,model:"",baseurl:"",timeout:30,contextid:0},void 0!==this.get("hasapikey")?(this._apiSettings.hasapikey=this.get("hasapikey"),this._apiSettings.model=this.get("model"),this._apiSettings.baseurl=this.get("baseurl"),this._apiSettings.timeout=this.get("timeout"),this._apiSettings.contextid=this.get("contextid")):M&&M.atto_aiimage&&M.atto_aiimage.settings&&(this._apiSettings.hasapikey=M.atto_aiimage.settings.hasapikey,this._apiSettings.model=M.atto_aiimage.settings.model,this._apiSettings.baseurl=M.atto_aiimage.settings.baseurl,this._apiSettings.timeout=M.atto_aiimage.settings.timeout,this._apiSettings.contextid=M.atto_aiimage.settings.contextid),i&&console.log(o+": Settings loaded",{hasapikey:this._apiSettings.hasapikey,model:this._apiSettings.model,baseurl:this._apiSettings.baseurl,timeout:this._apiSettings.timeout,contextid:this._apiSettings.contextid}),this._apiSettings.hasapikey?this.addButton({icon:"icon",iconComponent:n,callback:this._displayDialogue,callbackArgs:{customData:{component:n}},tags:"img",tagMatchRequiresAll:!1}):i&&console.log(o+": No API key configured, button not added to toolbar")},_displayDialogue:function(){if(i&&console.log(o+": Displaying dialogue"),!1!==(this._currentSelection=this.get("host").getSelection())){var e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:"650px",focusAfterHide:!0,focusOnShowSelector:"textarea."+r.INPUTPROMPT});this._content=this._getDialogueContent(),e.set("bodyContent",this._content),e.show()}},_getDialogueContent:function(){i&&console.log(o+": Building dialogue content");var t='<div class="'+r.PROCESSING+'" style="display:none"><div class="mdl-align"><img src="{{gif}}" alt="" class="spinner" /><span class="processing-text">{{get_string "processing" component}}</span></div></div><form class="atto_form"><div class="mb-3"><label for="{{elementid}}_'+r.INPUTPROMPT+'" class="form-label">{{get_string "promptlabel" component}}</label><textarea class="form-control fullwidth '+r.INPUTPROMPT+'" rows="5" id="{{elementid}}_'+r.INPUTPROMPT+'" required></textarea></div><div class="mb-3"><label class="form-label">{{get_string "aspectratiolabel" component}}</label><div class="form-check"><input class="form-check-input '+r.ASPSETRATIO_SQUARE+'" type="radio" name="aspectratio" id="{{elementid}}_'+r.ASPSETRATIO_SQUARE+'" value="square" checked><label class="form-check-label" for="{{elementid}}_'+r.ASPSETRATIO_SQUARE+'">{{get_string "aspectratio_square" component}}</label></div><div class="form-check"><input class="form-check-input '+r.ASPSETRATIO_LANDSCAPE+'" type="radio" name="aspectratio" id="{{elementid}}_'+r.ASPSETRATIO_LANDSCAPE+'" value="landscape"><label class="form-check-label" for="{{elementid}}_'+r.ASPSETRATIO_LANDSCAPE+'">{{get_string "aspectratio_landscape" component}}</label></div><div class="form-check"><input class="form-check-input '+r.ASPSETRATIO_PORTRAIT+'" type="radio" name="aspectratio" id="{{elementid}}_'+r.ASPSETRATIO_PORTRAIT+'" value="portrait"><label class="form-check-label" for="{{elementid}}_'+r.ASPSETRATIO_PORTRAIT+'">{{get_string "aspectratio_portrait" component}}</label></div></div><div class="mdl-align"><button class="btn btn-secondary '+r.INPUTCANCEL+'">{{get_string "cancel" component}}</button><button class="btn btn-primary ml-1 '+r.INPUTSUBMIT+'">{{get_string "generatebutton" component}}</button></div></form>',a=e.Handlebars.compile(t),s=e.Node.create(a({component:n,elementid:this.get("host").get("elementid"),CSS:r,gif:M.util.image_url("i/loading","core"),get_string:M.util.get_string}));if(!(this._form=s.one("form")))return console.error(o+": Form element not created"),s;var l=s.one("."+r.PROCESSING);l||i&&console.error(o+": Processing element could not be created");var _=this._form.one("."+r.INPUTSUBMIT),c=this._form.one("."+r.INPUTCANCEL),u=this._form.one("."+r.INPUTPROMPT);return i&&console.log(o+": Form elements: ",{form:!!this._form,processingElement:!!l,submitButton:!!_,cancelButton:!!c,promptTextarea:!!u}),_&&_.on("click",this._generateImage,this),c&&c.on("click",this._cancel,this),u&&u.on("key",function(e){if(13===e.keyCode)return e.preventDefault(),!0},"press:13",this),s},_generateImage:function(t){if(t.preventDefault(),i&&console.log(o+": Generate button clicked"),this._form){if(this._form.all("input, textarea, button").set("disabled",!0),!this._content)return void(i&&console.error(o+": Content container not found"));var a=this._content.one("."+r.PROCESSING);a?(a.setStyle("display","block"),i&&console.log(o+": Processing element found and displayed")):i&&console.warn(o+": Processing element not found in content container");var s=this._form.one("."+r.INPUTPROMPT);if(!s)return i&&console.error(o+": Prompt textarea not found"),void this._showError(M.util.get_string("error",n));var l=s.get("value").trim(),_="square",c=this._form.one("."+r.ASPSETRATIO_LANDSCAPE),u=this._form.one("."+r.ASPSETRATIO_PORTRAIT);c&&c.get("checked")?_="landscape":u&&u.get("checked")&&(_="portrait"),i&&(console.log(o+": Generating image with prompt: "+l),console.log(o+": Aspect ratio: "+_)),l?e.io(M.cfg.wwwroot+"/lib/editor/atto/plugins/aiimage/ajax.php",{method:"POST",data:{action:"generate",contextid:this._apiSettings.contextid,sesskey:M.cfg.sesskey,prompt:l,apikey:"",baseurl:this._apiSettings.baseurl,model:this._apiSettings.model,timeout:this._apiSettings.timeout,aspectratio:_},on:{success:function(e,t){try{var r=JSON.parse(t.responseText);i&&console.log(o+": API response",r),r.success?this._insertImage(r.content):this._showError(r.error||M.util.get_string("error",n))}catch(e){i&&console.error(o+": Error parsing response",e),this._showError(M.util.get_string("error",n))}},failure:function(){i&&console.error(o+": API request failed"),this._showError(M.util.get_string("error",n))}},context:this}):this._showError(M.util.get_string("error",n))}else console.error(o+": Form not found")},_insertImage:function(e){try{var t=this.get("host");if(!t)throw new Error("Editor host not found");if(i&&console.log(o+": HTML to insert:",e),d=this.getDialogue(),this._isInserting)return void(i&&console.warn(o+": Recursive insertion detected, aborting"));this._isInserting=!0;try{this._currentSelection&&(t.setSelection(this._currentSelection),i&&console.log(o+": Selection restored")),this.markUpdated(),t.insertContentAtFocusPoint(e),i&&console.log(o+": Content inserted successfully")}catch(e){throw i&&console.error(o+": Error during content insertion:",e),e}finally{this._isInserting=!1}setTimeout(function(){d&&(d.hide(),i&&console.log(o+": Dialogue hidden"))},100)}catch(t){i&&console.error(o+": Failed to insert image:",t),this._showError(M.util.get_string("error",n)+" - "+(t.message||"Unknown error")),this._form&&this._form.all("input, textarea, button").set("disabled",!1);var a=this._content.one("."+r.PROCESSING);a&&a.setStyle("display","none"),this._isInserting=!1}var d},_showError:function(t){if(i&&console.error(o+": Error: "+t),this._content){var n=this._content.one("."+r.PROCESSING);n&&n.setStyle("display","none")}if(this._form){this._form.all("input, textarea, button").set("disabled",!1);var a=e.Node.create('<div class="alert alert-danger"></div>');a.set("text",t),this._form.insertBefore(a,this._form.one("div"))}},_cancel:function(e){e.preventDefault(),this.getDialogue().hide()}},{ATTRS:{hasapikey:{value:!1},model:{value:""},baseurl:{value:""},timeout:{value:30},contextid:{value:0}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-notification-dialogue"]}); 